---
import defaultArrow from "../assets/photos/arrow_white.png";

export interface Props {
  src?: string | { src: string; width?: number; height?: number };
  amp?: string;        // e.g. "8px"
  period?: string;     // e.g. "1.6s"
  scale?: number;      // e.g. 1.35
  bottom?: string;     // e.g. "32px"
  z?: number;          // e.g. 60
  width?: string;      // e.g. "64px"

  /** Hide after scrolling this many px (0 or undefined = never hide) */
  hideAtPx?: string;   // e.g. 500
  /** Width of the fade band around hideAtPx (in px) */
  fadeSpanPx?: number; // e.g. 160
  class?: string;
  ariaLabel?: string;
}

const {
  src = defaultArrow,
  amp = "8px",
  period = "1.6s",
  scale = 1,
  bottom = "24px",
  z = 50,
  width = "48px",
  hideAtPx = 0,
  fadeSpanPx = 160,
  class: className = "",
  ariaLabel = "Scroll down",
} = Astro.props;

const withBase = (u?: string) =>
  (typeof u === 'string' && u.startsWith('/'))
    ? import.meta.env.BASE_URL + u.slice(1)
    : u;

const toUrl = (v?: string | { src: string }) =>
  typeof v === 'string' ? withBase(v) : v?.src;

const url = toUrl(src) ?? defaultArrow.src;
const iW  = typeof src === "string" ? undefined : src.width;
const iH  = typeof src === "string" ? undefined : src.height;
---

<style>
  .scroll-arrow {
    position: fixed; left: 50%;
    transform: translateX(-50%) translateY(0) scale(var(--scale));
    bottom: var(--bottom); width: var(--w);
    z-index: var(--z);
    filter: opacity(var(--alpha,1));
    animation: arrow-bounce var(--period) ease-in-out infinite;
    will-change: transform, filter;
  }

  @keyframes arrow-bounce {
    0%, 100% { transform: translateX(-50%) translateY(-0.25rem) scale(var(--scale)); }
    50%      { transform: translateX(-50%) translateY(var(--amp))   scale(var(--scale)); }
  }
</style>

<img
  src={url}
  alt={ariaLabel}
  width={iW}
  height={iH}
  class={`scroll-arrow ${className}`}
  style={`--amp:${amp}; --period:${period}; --scale:${scale}; --bottom:${bottom}; --z:${z}; --w:${width}; --alpha:1;`}
  data-hideat={hideAtPx || 0}
  data-fadespan={String(fadeSpanPx)}
  loading="eager"
  decoding="sync"
/>

<script is:inline>
(function(){
  var el = document.currentScript && document.currentScript.previousElementSibling;
  if (!(el && el.tagName === 'IMG')) return;

  var hideAt = parseFloat(el.getAttribute('data-hideat') || '0') || 0;
  var span   = Math.max(1, parseFloat(el.getAttribute('data-fadespan') || '160'));
  if (!hideAt) return; // no hiding requested

  function smoothstep(a, b, x){
    var t = Math.max(0, Math.min(1, (x - a) / Math.max(1e-6, b - a)));
    return t*t*(3 - 2*t);
  }

  function update(){
    var y = window.scrollY || window.pageYOffset || 0;
    var start = hideAt - span * 0.5;
    var end   = hideAt + span * 0.5;
    var fade  = smoothstep(start, end, y); // 0..1
    var alpha = 1 - fade;
    el.style.setProperty('--alpha', String(alpha));
  }

  update();
  window.addEventListener('scroll', update, { passive:true });
  window.addEventListener('resize', update, { passive:true });
})();
</script>
